<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.27.1" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="author" href="../../humans.txt" />
    <link href="//fonts.googleapis.com/css?family=Patrick+Hand+SC|Fira+Sans:400,400i,700&amp;subset=vietnamese" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai-sublime.min.css">
    <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="../../css/styles.css?v=2">
    <link rel="stylesheet" href="../../css/custom.css?v=3">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="https://khanhicetea.com/index.xml">

    <link rel="apple-touch-icon" sizes="57x57" href="../../favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../../favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../../favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../../favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../../favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../../favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../../favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../../favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../../favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../favicons/favicon-16x16.png">
    <link rel="manifest" href="../../favicons/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/favicons/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    
    <title>Building Automated CI server with Drone and Docker - KhanhIceTea B(rain)-log</title>
    <meta property='og:title' content="Building Automated CI server with Drone and Docker - KhanhIceTea B(rain)-log">
    <meta property="og:type" content="article">
    

    <meta property="og:url" content="https://khanhicetea.com/post/building-automated-ci-server-with-drone-and-docker/">
    
        <meta name="description" content="Lets automate all the things !">
        <meta property="og:description" content="Lets automate all the things !">
    
    <meta property="og:image" content="https://khanhicetea.com/images/2017/11/drone.png">

  </head>

  <body>

    <header class="site">
        <div class="title">
          <a href="https://khanhicetea.com/">KhanhIceTea B(rain)-log</a>
          <p class="lead">Does it matter ? ¯\_(ツ)_/¯</p>
        </div>
    </header>

    <div class="container site">


<div class="row">
<div class="col-sm-9 single-post">

    <article class="single" itemscope="itemscope" itemtype="http://schema.org/Article">

    <meta itemprop="mainEntityOfPage"  itemType="https://schema.org/WebPage" content="https://khanhicetea.com/"/>
    <meta itemprop="dateModified" content="2017-11-08T17:20:46&#43;07:00">
    <meta itemprop="headline" content="Building Automated CI server with Drone and Docker">
    <meta itemprop="description" content="Introduction Docker is great tool to management linux containers. It brings DevOps to next level, from development to production environment. And of course, before deploy anything to production, software should be tested carefully and automatically.
That&rsquo;s why Drone, a new lightweight CI server built-on top Go lang and Docker, will help us to resolve the testing problems in simple and fast way.
Setup This guide will assume you already have Docker and Docker Compose tool.">
    <meta itemprop="url" content="https://khanhicetea.com/post/building-automated-ci-server-with-drone-and-docker/">
    <div itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
        <meta itemprop="url" content="https://khanhicetea.com/images/2017/11/drone.png" />
        <meta itemprop="width" content="800">
        <meta itemprop="height" content="800">
    </div>
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
        <meta itemprop="url" content="https://khanhicetea.com/images/logo.jpg">
        <meta itemprop="width" content="100">
        <meta itemprop="height" content="100">
        </div>
        <meta itemprop="name" content="KhanhIceTea B(rain)-log">
    </div>
    <div itemprop="author" itemscope itemtype="https://schema.org/Person">
        <meta itemprop="name" content="KhanhIceTea">
    </div>

    <div class="image" style="background-image: url(https://khanhicetea.com/images/2017/11/drone.png);"></div>

    <header class="article-header">
        <time class="label label-primary" itemprop="datePublished" pubdate="pubdate" datetime="2017-11-08T17:20:46&#43;07:00">Wed, Nov 8 2017, 17:20</time>
        <h1 class="article-title">Building Automated CI server with Drone and Docker</h1>
    </header>

    <div class="article-body" itemprop="articleBody">
        

<h2 id="introduction">Introduction</h2>

<p><strong>Docker</strong> is great tool to management linux containers. It brings DevOps to next level, from development to production environment. And of course, before deploy anything to production, software should be tested carefully and <strong>automatically</strong>.</p>

<p>That&rsquo;s why <strong>Drone</strong>, a new lightweight CI server built-on top Go lang and Docker, will help us to resolve the testing problems in simple and fast way.</p>

<h2 id="setup">Setup</h2>

<p>This guide will assume you already have Docker and Docker Compose tool. And of course, root permission ;)</p>

<p><strong>Step 1</strong> : Clone my example docker-compose here : <a href="https://github.com/khanhicetea/drone-ci">https://github.com/khanhicetea/drone-ci</a></p>

<pre><code class="language-bash">$ git clone https://github.com/khanhicetea/drone-ci
$ cd drone-ci
$ cp .env.example .env
</code></pre>

<p><strong>Step 2</strong> : Update your setting in <code>.env</code> file</p>

<p><strong>Step 3</strong> : Run drone via docker-compose</p>

<pre><code class="language-bash">$ source .env
$ sudo docker-compose up -d
</code></pre>

<p><strong>Step 4</strong> : Go to your Drone url (remember use https url), then authorize with Github provider.</p>

<h2 id="usage">Usage</h2>

<p>In example repo, I created a sample <code>.drone.sample.yml</code> file so you can follow the structure to create own file.</p>

<p>I will explain some basics here</p>

<pre><code class="language-yaml">clone:
  git:
    image: plugins/git
    depth: 5

pipeline:
  phpunit:
    image: php:7
    commands:
      - /bin/sh conflict_detector.sh
      - /bin/sh phplinter.sh app lib test
      - composer install -q --prefer-dist
      - test/db/import testdatabase root passwd testdb test.sql
      - php -d memory_limit=256M vendor/bin/phpunit --no-coverage --colors=never
  
  notify:
    image: plugins/slack
    webhook: [your_slack_webhook_url]
    channel: deployment
    username: DroneCI
    when:
      status: success
  
  notify-bug:
    image: plugins/slack
    webhook: [your_slack_webhook_url]
    channel: bugs
    username: DroneCI
    when:
      status: failure
      branch: production

services:
  testdatabase:
    image: mysql:5.7
    detach: true
    environment:
      - MYSQL_DATABASE=testdb
      - MYSQL_ROOT_PASSWORD=passwd
</code></pre>

<p><strong>This file consists 3 sections :</strong></p>

<ul>
<li>clone : To clone the source code and prepare for <code>pipeline</code> step. This section will be run first</li>
<li>services : Declare your docker services (databases, ip server) which source code connect to. This section will be run at sametime with <code>pipeline</code> (after <code>clone</code>)</li>
<li>pipeline : Testing pipe, where you put testing logic here.</li>
</ul>

<p><strong>In this <code>pipeline</code>, I made a example PHP testing through these steps :</strong></p>

<ol>
<li>Check conflicts in code (grep for <code>&gt;&gt;&gt;&gt; HEAD</code> string)</li>
<li>Run PHP linter in application codes</li>
<li>Run Composer to install all dependencies</li>
<li>Import testing database to mysql services (using <code>testdatabase</code> hostname to connect service)</li>
<li>Run testing script via <code>phpunit</code> tool</li>
</ol>

<p>Then, notify testing result via Slack channel ! ;)</p>

<h2 id="a-picture-is-worth-a-thousand-words">A picture is worth a thousand words</h2>

<p><img src="../../images/2017/11/drone-ci.png" alt="Drone CI screenshot" /></p>

<blockquote>
<p>Lets automate all the things !</p>
</blockquote>

    </div>

    <div id="author-info">
    <img alt="author profile picture" class="avatar avatar-120 photo" src="../../images/profile_pic.jpg">
    <h5>Khanh Nguyen,</h5>
    <p>A human, walker, full-stack developer and writer. I love sharing ideas by writing and contributing open source on <a href="https://github.com/khanhicetea" target="_blank">Github</a>. My motto : <i>"Everything is trade-off".</i><br />Subscribe and follow with <a href="https://feeds.feedburner.com/khanhicetea" rel="nofollow" target="_blank">RSS</a> | <a href="https://twitter.com/khanhicetea" rel="nofollow" target="_blank"> Twitter </a></p>
</div>

    <aside>
    <div class="section"><a href="https://khanhicetea.com/tags/ci" class="label label-info">ci</a> <a href="https://khanhicetea.com/tags/docker" class="label label-info">docker</a> <a href="https://khanhicetea.com/tags/testing" class="label label-info">testing</a> <a href="https://khanhicetea.com/tags/english" class="label label-info">english</a> </div>

    <nav>
        <ul class="pager">
            
            <li class="previous"><a href="https://khanhicetea.com/xiny/how-i-learn-golang-goroutines-in-1-day/"><span aria-hidden="true">&larr;</span> \b</a></li>
            
            
            <li class="next"><a href="https://khanhicetea.com/post/aws-gcp-azure-ip-ranges/"><span aria-hidden="true">&rarr;</span> Getting AWS, GCP and Azure IP ranges</a></li>
            
        </ul>
    </nav>

    <div class="section share">
    <a href="http://www.facebook.com/sharer.php?src=bm&u=https%3a%2f%2fkhanhicetea.com%2fpost%2fbuilding-automated-ci-server-with-drone-and-docker%2f&t=Building%20Automated%20CI%20server%20with%20Drone%20and%20Docker" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><i class="fa fa-facebook"></i></a>
    <a href="http://twitter.com/intent/tweet?url=https%3a%2f%2fkhanhicetea.com%2fpost%2fbuilding-automated-ci-server-with-drone-and-docker%2f&text=Building%20Automated%20CI%20server%20with%20Drone%20and%20Docker&tw_p=tweetbutton" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><i class="fa fa-twitter"></i></a>
    <a href="https://plus.google.com/share?url=https%3a%2f%2fkhanhicetea.com%2fpost%2fbuilding-automated-ci-server-with-drone-and-docker%2f" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><i class="fa fa-google-plus"></i></a>
    <a href="http://getpocket.com/edit?url=https%3a%2f%2fkhanhicetea.com%2fpost%2fbuilding-automated-ci-server-with-drone-and-docker%2f&title=Building%20Automated%20CI%20server%20with%20Drone%20and%20Docker" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><i class="fa fa-get-pocket"></i></a>
    </div>

    
    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
(function() {
var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
var disqus_shortname = 'khanhicetea';
dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    
</aside>

    </article>
</div>

<div class="col-sm-3">
    <aside class="site">

  
  <div class="section">
    <header><div class="title">TableOfContents</div></header>
    <div class="list-default"><nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#a-picture-is-worth-a-thousand-words">A picture is worth a thousand words</a></li>
</ul></li>
</ul>
</nav></div>
  </div>
  

  

  
  <div class="section">
    <header><div class="title">Latest Logs</div></header>
    <div class="content">
      
      <div class="sm"><article class="li">
  <a href="https://khanhicetea.com/post/random-year-2017/" class="clearfix">
    <div class="image" style="background-image: url(https://khanhicetea.com/images/2017/12/year2017.jpg);"></div>
    <div class="detail">
      <h2 class="title">Random Year #2017</h2>
      <time>Sun, Dec 31, 2017</time>
      <div class="summary">What a f*cking year !</div>
    </div>
  </a>
</article>
</div>
      
      <div class="sm"><article class="li">
  <a href="https://khanhicetea.com/post/what-are-the-best-things-to-invest-in-right-now/" class="clearfix">
    <div class="image" style="background-image: url(https://khanhicetea.com/images/2017/12/get-started-investing.jpg);"></div>
    <div class="detail">
      <h2 class="title">What are the best things to INVEST in right now ?</h2>
      <time>Thu, Dec 14, 2017</time>
      <div class="summary">We are human, we were born, we are living and we will die soon. As a financial point of view, life is a business !</div>
    </div>
  </a>
</article>
</div>
      
      <div class="sm"><article class="li">
  <a href="https://khanhicetea.com/til/2017-12-07/" class="clearfix">
    <div class="image" style="background-image: url(https://khanhicetea.com/images/kit_logo.png);"></div>
    <div class="detail">
      <h2 class="title">#TIL 2017-12-07 : til, web, proxy, firewall</h2>
      <time>Thu, Dec 7, 2017</time>
      <div class="summary">I learned in 2017-12-07 about Using web proxy to bypass firewalls</div>
    </div>
  </a>
</article>
</div>
      
      <div class="sm"><article class="li">
  <a href="https://khanhicetea.com/til/2017-11-27/" class="clearfix">
    <div class="image" style="background-image: url(https://khanhicetea.com/images/kit_logo.png);"></div>
    <div class="detail">
      <h2 class="title">#TIL 2017-11-27 : til, ci, git, automation</h2>
      <time>Mon, Nov 27, 2017</time>
      <div class="summary">I learned in 2017-11-27 about Fastly conflict detector script</div>
    </div>
  </a>
</article>
</div>
      
      <div class="sm"><article class="li">
  <a href="https://khanhicetea.com/til/2017-11-24/" class="clearfix">
    <div class="image" style="background-image: url(https://khanhicetea.com/images/kit_logo.png);"></div>
    <div class="detail">
      <h2 class="title">#TIL 2017-11-24 : til, sysadmin, dns, ip</h2>
      <time>Fri, Nov 24, 2017</time>
      <div class="summary">I learned in 2017-11-24 about Getting your external IP</div>
    </div>
  </a>
</article>
</div>
      
    </div>
  </div>
  

  
  <div class="section taxonomies">
    <header><div class="title">Categories</div></header>
    <div class="content">
      <a href="https://khanhicetea.com/categories/today-i-learned">today-i-learned [40]</a><a href="https://khanhicetea.com/categories/life">life [32]</a><a href="https://khanhicetea.com/categories/sysadmin">sysadmin [21]</a><a href="https://khanhicetea.com/categories/english">english [9]</a><a href="https://khanhicetea.com/categories/php">php [8]</a><a href="https://khanhicetea.com/categories/linux">linux [6]</a><a href="https://khanhicetea.com/categories/docker">docker [5]</a><a href="https://khanhicetea.com/categories/mysql">mysql [5]</a><a href="https://khanhicetea.com/categories/python">python [5]</a><a href="https://khanhicetea.com/categories/tech">tech [4]</a>
    </div>
  </div>
  
  <div class="section taxonomies">
    <header><div class="title">Tags</div></header>
    <div class="content">
      <a href="https://khanhicetea.com/tags/english">english [42]</a><a href="https://khanhicetea.com/tags/til">til [40]</a><a href="https://khanhicetea.com/tags/life">life [31]</a><a href="https://khanhicetea.com/tags/sysadmin">sysadmin [22]</a><a href="https://khanhicetea.com/tags/random">random [21]</a><a href="https://khanhicetea.com/tags/vietnamese">vietnamese [13]</a><a href="https://khanhicetea.com/tags/php">php [11]</a><a href="https://khanhicetea.com/tags/bash">bash [9]</a><a href="https://khanhicetea.com/tags/devops">devops [7]</a><a href="https://khanhicetea.com/tags/docker">docker [7]</a>
    </div>
  </div>
  

  <div class="section taxonomies">
    <header><div class="title">whoami</div></header>
    <div class="content">
      <a href="../../humans.txt"><i class="fa fa-user-circle-o"></i> I am a human ! I make misstakes. Oops..I made it</a>
      
      <a href="https://github.com/khanhicetea"><i class="fa fa-github"></i> Github</a>
      
      <a href="https://libraries.io/github/khanhicetea"><i class="fa fa-th-list"></i> Libraries.io</a>
      
      <a href="https://vn.linkedin.com/in/khanhicetea"><i class="fa fa-linkedin-square"></i> LinkedIn</a>
      
    </div>
  </div>

  

</aside>

</div>

</div>

    </div>

    <footer class="site">
      <p><strong>- In God We Trust -</strong></p>
      <p>&copy; 2017 KhanhIceTea B(rain)-log</p>
      <p>Licensed under <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/" target="_blank">CC BY-NC-ND 3.0</a></p>
      <p>Powered by <a href="http://gohugo.io" target="_blank">Hugo</a> and <a href="https://github.com/khanhicetea/.com" target="_blank">GitHub Pages</a></p>
      <p>Theme <a href="https://github.com/dim0627/hugo_theme_robust" target="_blank">Robust</a> designed by <a href="http://yet.unresolved.xyz" target="_blank">Daisuke Tsuji</a>, background texture <a href="http://www.freepik.com/free-vector/unevenly-painted-wall-texture_769342.htm">designed by Freepik</a>, the little prince art by <a href="http://princekido.deviantart.com/art/The-Little-Prince-and-the-Fox-in-the-Light-603126189">princekido</a></p>
    </footer>

    <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="../../js/highlight.js"></script>
    <script>
      $(document).ready(function() {
        hljs.configure({tabReplace: '    '});
        $('.article-body pre code').each(function(i, block) {
          hljs.highlightBlock(block);
        });
        $(".article-body p").has("img").css('text-align', "center");
        $(".article-body a").attr('target','_blank');
        $(".article-body table").addClass('table').addClass('table-bordered');
      });
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-50390703-1', 'auto');

      jQuery.getJSON("https://api.ipify.org?format=json", function(data) {
        ga('set', 'dimension1', data.ip);
        ga('send', 'pageview');
        setInterval(function() {
            ga('send', 'pageview');
        }, 60000);
      });

    </script>

  </body>
</html>
