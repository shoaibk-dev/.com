<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.27.1" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="author" href="../../humans.txt" />
    <link href="//fonts.googleapis.com/css?family=Patrick+Hand+SC|Fira+Sans:400,400i,700&amp;subset=vietnamese" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai-sublime.min.css">
    <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="../../css/styles.css?v=2">
    <link rel="stylesheet" href="../../css/custom.css?v=3">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="https://khanhicetea.com/index.xml">

    <link rel="apple-touch-icon" sizes="57x57" href="../../favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../../favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../../favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../../favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../../favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../../favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../../favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../../favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../../favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../favicons/favicon-16x16.png">
    <link rel="manifest" href="../../favicons/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/favicons/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    
    <title>How to reload gracefully supervisor program - KhanhIceTea B(rain)-log</title>
    <meta property='og:title' content="How to reload gracefully supervisor program - KhanhIceTea B(rain)-log">
    <meta property="og:type" content="article">
    

    <meta property="og:url" content="https://khanhicetea.com/post/how-to-reload-gracefully-supervisor-program/">
    
        <meta name="description" content="It’s creepy when supervisor kills all processes of programs and starts them again.">
        <meta property="og:description" content="It’s creepy when supervisor kills all processes of programs and starts them again.">
    
    

  </head>

  <body>

    <header class="site">
        <div class="title">
          <a href="https://khanhicetea.com/">KhanhIceTea B(rain)-log</a>
          <p class="lead">Does it matter ? ¯\_(ツ)_/¯</p>
        </div>
    </header>

    <div class="container site">


<div class="row">
<div class="col-sm-9 single-post">

    <article class="single" itemscope="itemscope" itemtype="http://schema.org/Article">

    <meta itemprop="mainEntityOfPage"  itemType="https://schema.org/WebPage" content="https://khanhicetea.com/"/>
    <meta itemprop="dateModified" content="2017-03-25T13:59:26&#43;07:00">
    <meta itemprop="headline" content="How to reload gracefully supervisor program">
    <meta itemprop="description" content="Problem We have some managed worker-programs by supervisor. While deploying new codebase of worker, we have to restart them to update new logic.
But it&rsquo;s creepy when supervisor kills all processes of programs and starts again.
WHAT IF IT KILLS A WORKING WORKER ?
Of course, the working task will be fucked up. Database transaction, database migration, sending email and other scheduled tasks will be crashed in middle. Some tasks can&rsquo;t not be reserved, rollbacked or re-runned.">
    <meta itemprop="url" content="https://khanhicetea.com/post/how-to-reload-gracefully-supervisor-program/">
    <div itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
        <meta itemprop="url" content="https://khanhicetea.com/images/default.jpg" />
        <meta itemprop="width" content="800">
        <meta itemprop="height" content="800">
    </div>
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
        <meta itemprop="url" content="https://khanhicetea.com/images/logo.jpg">
        <meta itemprop="width" content="100">
        <meta itemprop="height" content="100">
        </div>
        <meta itemprop="name" content="KhanhIceTea B(rain)-log">
    </div>
    <div itemprop="author" itemscope itemtype="https://schema.org/Person">
        <meta itemprop="name" content="KhanhIceTea">
    </div>

    <div class="image" style="background-image: url(https://khanhicetea.com/images/default.jpg);"></div>

    <header class="article-header">
        <time class="label label-primary" itemprop="datePublished" pubdate="pubdate" datetime="2017-03-25T13:59:26&#43;07:00">Sat, Mar 25 2017, 13:59</time>
        <h1 class="article-title">How to reload gracefully supervisor program</h1>
    </header>

    <div class="article-body" itemprop="articleBody">
        

<h2 id="problem">Problem</h2>

<p>We have some managed worker-programs by <a href="http://supervisord.org/index.html">supervisor</a>. While deploying new codebase of worker, we have to restart them to update new logic.</p>

<p>But it&rsquo;s creepy when supervisor kills all processes of programs and starts again.</p>

<p><strong>WHAT IF IT KILLS A WORKING WORKER ?</strong></p>

<p>Of course, the working task will be fucked up. Database transaction, database migration, sending email and other scheduled tasks will be <strong>crashed in middle</strong>. Some tasks can&rsquo;t not be reserved, rollbacked or re-runned.</p>

<blockquote>
<p>And your customer can&rsquo;t trust in you twice.</p>
</blockquote>

<h2 id="generic-solution">Generic Solution</h2>

<p>In movie, people want to do last thing (say last words, have last kiss or even enjoy last song) then kill themself. So computer programs should have that favour, let them finishes their tasks and kill themself instead of being shooted by a UNIX signal.</p>

<p><img src="../../images/2017/03/blowing-ship.gif" alt="Keep calm" /></p>

<h2 id="mutex-lock-file-mechanism">Mutex lock file mechanism</h2>

<p>Get back to think, the main roles of supervisor are monitoring and controlling a number of processes on UNIX-like OS. Easier explaination : supervisor tracks processes and tries to re-init them if they were crashed in somehow.</p>

<p>So if you want to reload a program, just let it kills itself. Then supervisor do the remain job (re-init processes).</p>

<h3 id="pseudo-implementation">Pseudo implementation</h3>

<p>Worker code</p>

<pre><code>function doSomeJob() {
    // Create a lock file to notify it's doing task so don't shoot it
    touch_file('/tmp/somejob.lock')
    // Doing task
    do_it_here()
    // Checking lockfile
    if (is_file_exists('/tmp/somejob.lock')) {
        remove_file('/tmp/somejob.lock')
    } else {
        kill_myself()
    }
}
</code></pre>

<p>Deploying code</p>

<pre><code class="language-bash">[[ -e /tmp/somejob.lock ]] &amp;&amp; rm /tmp/somejob.lock || supervisor restart program1
</code></pre>

<h3 id="php-worker-and-ansible">PHP worker and Ansible</h3>

<p>Worker code</p>

<pre><code class="language-php">function doSomeTask() {
    touch('/tmp/somejob.lock');
    // Doing task
    do_it_here();
    // Checking lockfile
    if (file_exists('/tmp/somejob.lock')) {
        unlink('/tmp/somejob.lock');
    } else {
        exit();
    }
}
</code></pre>

<p>Ansible tasks</p>

<pre><code>- name: Check if woker lock file exists
  stat: path=/tmp/somejob.lock
  register: check_worker_lock

- name: Remove if worker lock file exists
  file:
    path: /tmp/somejob.lock
    state: absent
  when: check_worker_lock.stat.exists
</code></pre>

<p>Ansible handlers</p>

<pre><code>- name: reload supervisor
  supervisorctl:
    name: worker
    state: restarted
  when: check_worker_lock.stat.exists == False
</code></pre>

<h2 id="short-explanation-by-image">Short explanation by image</h2>

<p><img src="../../images/2017/03/water-bazooka-rocket-kid-face.gif" alt="bazooka fail kid" /></p>

<hr />

<p><strong>Ref:</strong></p>

<ul>
<li>Meme from Google photo search</li>
</ul>

    </div>

    <div id="author-info">
    <img alt="author profile picture" class="avatar avatar-120 photo" src="../../images/profile_pic.jpg">
    <h5>Khanh Nguyen,</h5>
    <p>A human, walker, full-stack developer and writer. I love sharing ideas by writing and contributing open source on <a href="https://github.com/khanhicetea" target="_blank">Github</a>. My motto : <i>"Everything is trade-off".</i><br />Subscribe and follow with <a href="https://feeds.feedburner.com/khanhicetea" rel="nofollow" target="_blank">RSS</a> | <a href="https://twitter.com/khanhicetea" rel="nofollow" target="_blank"> Twitter </a></p>
</div>

    <aside>
    <div class="section"><a href="https://khanhicetea.com/tags/system" class="label label-info">system</a> <a href="https://khanhicetea.com/tags/supervisor" class="label label-info">supervisor</a> <a href="https://khanhicetea.com/tags/devops" class="label label-info">devops</a> <a href="https://khanhicetea.com/tags/ansible" class="label label-info">ansible</a> <a href="https://khanhicetea.com/tags/php" class="label label-info">php</a> </div>

    <nav>
        <ul class="pager">
            
            <li class="previous"><a href="https://khanhicetea.com/post/random-week-6/"><span aria-hidden="true">&larr;</span> \b</a></li>
            
            
            <li class="next"><a href="https://khanhicetea.com/post/random-week-7/"><span aria-hidden="true">&rarr;</span> Random week #7</a></li>
            
        </ul>
    </nav>

    <div class="section share">
    <a href="http://www.facebook.com/sharer.php?src=bm&u=https%3a%2f%2fkhanhicetea.com%2fpost%2fhow-to-reload-gracefully-supervisor-program%2f&t=How%20to%20reload%20gracefully%20supervisor%20program" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><i class="fa fa-facebook"></i></a>
    <a href="http://twitter.com/intent/tweet?url=https%3a%2f%2fkhanhicetea.com%2fpost%2fhow-to-reload-gracefully-supervisor-program%2f&text=How%20to%20reload%20gracefully%20supervisor%20program&tw_p=tweetbutton" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><i class="fa fa-twitter"></i></a>
    <a href="https://plus.google.com/share?url=https%3a%2f%2fkhanhicetea.com%2fpost%2fhow-to-reload-gracefully-supervisor-program%2f" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><i class="fa fa-google-plus"></i></a>
    <a href="http://getpocket.com/edit?url=https%3a%2f%2fkhanhicetea.com%2fpost%2fhow-to-reload-gracefully-supervisor-program%2f&title=How%20to%20reload%20gracefully%20supervisor%20program" onclick="window.open(this.href, 'PCwindow', 'width=550, height=350, menubar=no, toolbar=no, scrollbars=yes'); return false;"><i class="fa fa-get-pocket"></i></a>
    </div>

    
    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
(function() {
var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
var disqus_shortname = 'khanhicetea';
dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    
</aside>

    </article>
</div>

<div class="col-sm-3">
    <aside class="site">

  
  <div class="section">
    <header><div class="title">TableOfContents</div></header>
    <div class="list-default"><nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#problem">Problem</a></li>
<li><a href="#generic-solution">Generic Solution</a></li>
<li><a href="#mutex-lock-file-mechanism">Mutex lock file mechanism</a>
<ul>
<li><a href="#pseudo-implementation">Pseudo implementation</a></li>
<li><a href="#php-worker-and-ansible">PHP worker and Ansible</a></li>
</ul></li>
<li><a href="#short-explanation-by-image">Short explanation by image</a></li>
</ul></li>
</ul>
</nav></div>
  </div>
  

  

  
  <div class="section">
    <header><div class="title">Latest Logs</div></header>
    <div class="content">
      
      <div class="sm"><article class="li">
  <a href="https://khanhicetea.com/xiny/how-i-learn-golang-goroutines-in-1-day/" class="clearfix">
    <div class="image" style="background-image: url(https://khanhicetea.com/images/xiny.jpg);"></div>
    <div class="detail">
      <h2 class="title">How I Learn Golang Goroutines in 1 Day</h2>
      <time>Thu, Oct 26, 2017</time>
      <div class="summary">How did I learn Goroutines in 1 day</div>
    </div>
  </a>
</article>
</div>
      
      <div class="sm"><article class="li">
  <a href="https://khanhicetea.com/xiny/how-i-learn-golang-basics-in-1-day/" class="clearfix">
    <div class="image" style="background-image: url(https://khanhicetea.com/images/xiny.jpg);"></div>
    <div class="detail">
      <h2 class="title">How I Learn Golang Basics in 1 Day</h2>
      <time>Sat, Oct 21, 2017</time>
      <div class="summary">How did I learn Golang basics in 1 day</div>
    </div>
  </a>
</article>
</div>
      
      <div class="sm"><article class="li">
  <a href="https://khanhicetea.com/til/2017-10-20/" class="clearfix">
    <div class="image" style="background-image: url(https://khanhicetea.com/images/kit_logo.png);"></div>
    <div class="detail">
      <h2 class="title">What I learned in 2017-10-20</h2>
      <time>Fri, Oct 20, 2017</time>
      <div class="summary">I learned in 2017-10-20 about til, tool, watch, linux</div>
    </div>
  </a>
</article>
</div>
      
      <div class="sm"><article class="li">
  <a href="https://khanhicetea.com/til/2017-10-13/" class="clearfix">
    <div class="image" style="background-image: url(https://khanhicetea.com/images/kit_logo.png);"></div>
    <div class="detail">
      <h2 class="title">What I learned in 2017-10-13</h2>
      <time>Fri, Oct 13, 2017</time>
      <div class="summary">I learned in 2017-10-13 about ci, database, devops, indexes, til, netcat</div>
    </div>
  </a>
</article>
</div>
      
      <div class="sm"><article class="li">
  <a href="https://khanhicetea.com/xiny/how-i-learn-typescript-basics-in-2-days/" class="clearfix">
    <div class="image" style="background-image: url(https://khanhicetea.com/images/xiny.jpg);"></div>
    <div class="detail">
      <h2 class="title">Learn TypeScript Basics in 2 days</h2>
      <time>Sun, Oct 8, 2017</time>
      <div class="summary">How did I learn typescript basics in 2 days</div>
    </div>
  </a>
</article>
</div>
      
    </div>
  </div>
  

  
  <div class="section taxonomies">
    <header><div class="title">Categories</div></header>
    <div class="content">
      <a href="https://khanhicetea.com/categories/today-i-learned">today-i-learned [36]</a><a href="https://khanhicetea.com/categories/life">life [30]</a><a href="https://khanhicetea.com/categories/sysadmin">sysadmin [18]</a><a href="https://khanhicetea.com/categories/english">english [9]</a><a href="https://khanhicetea.com/categories/php">php [8]</a><a href="https://khanhicetea.com/categories/linux">linux [6]</a><a href="https://khanhicetea.com/categories/mysql">mysql [5]</a><a href="https://khanhicetea.com/categories/python">python [5]</a><a href="https://khanhicetea.com/categories/tech">tech [4]</a><a href="https://khanhicetea.com/categories/xiny">xiny [4]</a>
    </div>
  </div>
  
  <div class="section taxonomies">
    <header><div class="title">Tags</div></header>
    <div class="content">
      <a href="https://khanhicetea.com/tags/english">english [39]</a><a href="https://khanhicetea.com/tags/til">til [36]</a><a href="https://khanhicetea.com/tags/life">life [29]</a><a href="https://khanhicetea.com/tags/random">random [21]</a><a href="https://khanhicetea.com/tags/sysadmin">sysadmin [20]</a><a href="https://khanhicetea.com/tags/vietnamese">vietnamese [12]</a><a href="https://khanhicetea.com/tags/php">php [11]</a><a href="https://khanhicetea.com/tags/bash">bash [9]</a><a href="https://khanhicetea.com/tags/linux">linux [7]</a><a href="https://khanhicetea.com/tags/devops">devops [6]</a>
    </div>
  </div>
  

  <div class="section taxonomies">
    <header><div class="title">whoami</div></header>
    <div class="content">
      <a href="../../humans.txt"><i class="fa fa-user-circle-o"></i> I am a human ! I make misstakes. Oops..I made it</a>
      
      <a href="https://github.com/khanhicetea"><i class="fa fa-github"></i> Github</a>
      
      <a href="https://libraries.io/github/khanhicetea"><i class="fa fa-th-list"></i> Libraries.io</a>
      
      <a href="https://vn.linkedin.com/in/khanhicetea"><i class="fa fa-linkedin-square"></i> LinkedIn</a>
      
    </div>
  </div>

  

</aside>

</div>

</div>

    </div>

    <footer class="site">
      <p><strong>- In God We Trust -</strong></p>
      <p>&copy; 2017 KhanhIceTea B(rain)-log</p>
      <p>Licensed under <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/" target="_blank">CC BY-NC-ND 3.0</a></p>
      <p>Powered by <a href="http://gohugo.io" target="_blank">Hugo</a> and <a href="https://github.com/khanhicetea/.com" target="_blank">GitHub Pages</a></p>
      <p>Theme <a href="https://github.com/dim0627/hugo_theme_robust" target="_blank">Robust</a> designed by <a href="http://yet.unresolved.xyz" target="_blank">Daisuke Tsuji</a>, background texture <a href="http://www.freepik.com/free-vector/unevenly-painted-wall-texture_769342.htm">designed by Freepik</a>, the little prince art by <a href="http://princekido.deviantart.com/art/The-Little-Prince-and-the-Fox-in-the-Light-603126189">princekido</a></p>
    </footer>

    <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/typescript.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
    <script>
      $(document).ready(function() {
        hljs.configure({tabReplace: '    '});
        $('.article-body pre code').each(function(i, block) {
          hljs.highlightBlock(block);
        });
        $(".article-body p").has("img").css('text-align', "center");
        $(".article-body a").attr('target','_blank');
        $(".article-body table").addClass('table').addClass('table-bordered');
      });
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-50390703-1', 'auto');

      jQuery.getJSON("https://api.ipify.org?format=json", function(data) {
        ga('set', 'dimension1', data.ip);
        ga('send', 'pageview');
        setInterval(function() {
            ga('send', 'pageview');
        }, 60000);
      });

    </script>

  </body>
</html>
